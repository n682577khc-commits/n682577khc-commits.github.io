<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Squad Chores ‚ú®</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            /* Light Theme */
            --bg-color: #f2f2f7; 
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.6);
            --chore-bg: #ffffff;
            --menu-bg: #ffffff; 
            --overlay-bg: rgba(0, 0, 0, 0.4);
            --text-color: #000000;
            --subtext-color: #8e8e93;
            --input-bg: #f5f5f7;
            --title-color: #000000;
            --accent-btn: #000000;
            --accent-icon: #ffffff;
            --bounce: cubic-bezier(0.68, -0.6, 0.32, 1.6);
            
            /* Palette */
            --c0: #ff6b6b; --c1: #e056fd; --c2: #00cec9; --c3: #f9ca24; --c4: #4834d4;
        }

        body.dark-mode {
            --bg-color: #000000;
            --glass-bg: rgba(30, 30, 30, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --chore-bg: #1c1c1e;
            --menu-bg: #1c1c1e;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --bottom-bar-bg: rgba(30, 30, 30, 0.95);
            --text-color: #ffffff;
            --subtext-color: #98989d;
            --input-bg: #2c2c2e;
            --title-color: #8ace00; 
            --accent-btn: #ffffff;
            --accent-icon: #000000;
        }

        /* Themes */
        body.theme-pink { --bg-color: #ffeef0; --title-color: #ff6b81; }
        body.theme-blue { --bg-color: #e3f2fd; --title-color: #0984e3; }
        body.theme-green { --bg-color: #e6fffa; --title-color: #00b894; }
        body.theme-orange { --bg-color: #fff3e0; --title-color: #e17055; }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            width: 100%; height: 100%;
            overflow-x: hidden; 
            position: fixed; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }

        body {
            background-color: var(--bg-color);
            background: linear-gradient(-45deg, var(--bg-color), #f8f8f8, var(--bg-color));
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            color: var(--text-color); margin: 0; padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top)); padding-bottom: 150px;
        }
        body.dark-mode { background: linear-gradient(-45deg, #000000, #1a1a1a, #000000); background-size: 400% 400%; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        #capture-container { padding: 5px; border-radius: 30px; width: 100%; }
        body.snapping-mode .day-card { background: #ffffff; backdrop-filter: none; border: 1px solid #ddd; box-shadow: none; animation: none; }
        body.dark-mode.snapping-mode .day-card { background: #1c1c1e; border: 1px solid #333; }
        body.snapping-mode .chore-item { box-shadow: none; border: 1px solid rgba(0,0,0,0.1); animation: none; }

        /* HEADER */
        header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; width: 100%; position: relative; z-index: 50; }
        .header-left { display: flex; align-items: center; gap: 10px; position: relative; }
        h1 { font-family: "Arial Narrow", "Helvetica Condensed", sans-serif; font-weight: 800; color: var(--title-color); margin: 0; font-size: 2.4rem; letter-spacing: -2px; transform: scaleY(1.1); filter: blur(0.5px); white-space: nowrap; text-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        .week-dropdown-btn { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 14px; padding: 8px 14px; font-size: 0.85rem; font-weight: 700; cursor: pointer; color: var(--text-color); display: flex; align-items: center; gap: 6px; transition: transform 0.4s var(--bounce); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .week-dropdown-btn:active { transform: scale(0.9); }
        
        .header-tools { display: flex; align-items: center; gap: 8px; }
        .tool-pill { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 700; cursor: pointer; color: var(--text-color); box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.4s var(--bounce); }
        .tool-pill:active { transform: scale(0.85); }
        .settings-btn { background: var(--text-color); color: var(--bg-color); border:none; }

        /* GRID LOGIC */
        .schedule { display: grid; gap: 20px; transition: all 0.3s ease; width: 100%; padding-bottom: 100px; }
        .schedule.view-list { grid-template-columns: 1fr; }
        .schedule.view-board { grid-template-columns: 1fr 1fr; }
        
        /* CALENDAR VIEW */
        .schedule.view-calendar { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 20px; 
            scroll-snap-type: x mandatory; width: 100vw; 
            margin-left: -15px; padding-left: 15px; padding-right: 15px;
        }
        
        .schedule.view-calendar .day-card { 
            flex: 0 0 140px; height: 140px; scroll-snap-align: start;
            padding: 8px; overflow: visible; 
            box-shadow: none; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; 
        }
        .schedule.view-calendar .day-card.is-today { border: 2px solid var(--title-color); background: var(--input-bg); }
        .schedule.view-calendar .day-title { font-size: 0.65rem; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; color: var(--subtext-color); }
        .schedule.view-calendar .date-number { position: absolute; top: 4px; right: 6px; font-size: 0.8rem; font-weight: 800; color: var(--text-color); opacity: 0.5; }
        
        .schedule.view-calendar .chore-list { overflow-y: auto; flex-grow: 1; gap: 3px; scrollbar-width: none; }
        .schedule.view-calendar .chore-item { padding: 4px 6px; border-radius: 6px; font-size: 0.65rem; margin-bottom: 0; box-shadow: none; border: 1px solid rgba(0,0,0,0.05); min-height: auto; }
        .schedule.view-calendar .chore-checkbox { width: 10px; height: 10px; margin-right: 4px; border-radius: 3px; }
        .schedule.view-calendar .chore-text { font-size: 0.65rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .schedule.view-calendar .menu-btn, .schedule.view-calendar .chore-note-display, .schedule.view-calendar .due-badge { display: none; }
        .schedule.view-calendar .new-btn-ghost { padding: 4px; font-size: 0.7rem; margin-top: auto; border-radius: 6px; background: rgba(0,0,0,0.05); color: var(--text-color); border:none; }

        @media (max-width: 768px) { .schedule.view-calendar .day-card { flex: 0 0 32%; height: 110px; } }
        @media (min-width: 769px) { .schedule.view-list { grid-template-columns: 1fr 1fr; } .schedule.view-board { grid-template-columns: repeat(3, 1fr); } }

        /* STANDARD CARD */
        .day-card { background: var(--glass-bg); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0,0,0,0.05); padding: 24px; border-radius: 28px; display: flex; flex-direction: column; height: 100%; position: relative; transition: transform 0.3s; }
        .day-card.is-today { border: 2px solid var(--text-color); background: var(--input-bg); box-shadow: 0 10px 50px rgba(0,0,0,0.1); }
        .day-card:hover { transform: scale(1.02); }
        .day-title { font-size: 0.95rem; font-weight: 800; margin-bottom: 18px; color: #888; text-transform: uppercase; letter-spacing: 2px; display: flex; justify-content: space-between; align-items: center; }
        .date-display { font-size: 0.8rem; background: var(--input-bg); padding: 4px 8px; border-radius: 8px; color: var(--text-color); opacity: 0.7; }
        .date-number { font-size: 0; } 
        .chore-list { display: flex; flex-direction: column; gap: 0px; flex-grow: 1; }

        /* ITEMS */
        .chore-item { padding: 14px 16px; margin-bottom: 8px; border-radius: 18px; background: var(--chore-bg); display: flex; flex-direction: column; border-left: 6px solid transparent; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.03); color: var(--text-color); transition: transform 0.4s var(--bounce); position: relative; overflow: hidden; }
        .chore-item:last-child { margin-bottom: 0; }
        .chore-item.bouncing { animation: checkBounce 0.5s var(--bounce) forwards; }
        @keyframes checkBounce { 0% { transform: scale(1); } 40% { transform: scale(1.08); } 100% { transform: scale(0.98); } }
        .chore-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .chore-left { display: flex; align-items: center; gap: 12px; flex-grow: 1; overflow: hidden; }
        .chore-text { font-weight: 700; font-size: 1rem; user-select: none; letter-spacing: -0.3px; }
        .chore-checkbox { width: 22px; height: 22px; cursor: pointer; border-radius: 8px; accent-color: #333; transition: transform 0.2s var(--bounce); flex-shrink: 0; }
        .chore-checkbox:active { transform: scale(1.4); }
        .chore-note-display { padding-top: 6px; font-size: 0.9rem; color: var(--subtext-color); padding-left: 36px; line-height: 1.4; display: none; font-weight: 500;}
        .due-badge { font-size: 0.8rem; color: #ff3b30; font-weight: 800; margin-left: 36px; display: flex; align-items: center; gap: 6px; margin-top: 6px; }
        .due-badge.future { color: var(--subtext-color); }
        .chore-item.done { opacity: 0.6; filter: grayscale(1); background: transparent; border: 1px solid rgba(150,150,150,0.2); }
        .chore-item.done .chore-text { text-decoration: line-through; color: var(--subtext-color); }
        .menu-btn { background: transparent; border: none; color: #aaa; font-size: 1.3rem; font-weight: 900; cursor: pointer; padding: 5px 10px; }
        .empty-state { color: #888; font-size: 0.9rem; font-style: italic; padding: 15px 0; font-weight: 600; text-align: center; opacity: 0.7;}

        /* INLINE ADD (List Mode Only) */
        .inline-add-row { margin-top: auto; padding-top: 15px; display: flex; align-items: center; gap: 8px; position: relative; }
        .new-btn-ghost { background: rgba(0,0,0,0.03); border: 2px dashed rgba(0,0,0,0.1); color: #888; font-weight: 800; width: 100%; text-align: left; padding: 14px 16px; border-radius: 16px; cursor: pointer; transition: all 0.3s var(--bounce); }
        .new-btn-ghost:hover { background: rgba(0,0,0,0.06); transform: scale(1.02); }
        .inline-input-container { display: none; width: 100%; gap: 10px; animation: popIn 0.4s var(--bounce); align-items: flex-start; flex-direction: column; }
        .input-wrapper { display: flex; width: 100%; align-items: center; gap: 8px; margin-top: 8px; }
        
        .tiny-pill-scroll { display: flex; gap: 8px; overflow-x: auto; width: 100%; padding: 15px 5px; margin: -5px 0; scrollbar-width: none; }
        .tiny-pill { padding: 8px 16px; border-radius: 50px; border: none; font-size: 0.85rem; font-weight: 700; cursor: pointer; white-space: nowrap; background: var(--input-bg); color: #888; transition: transform 0.3s var(--bounce); transform: scale(0.95); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .tiny-pill.active { transform: scale(1.1); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .accent-0 { border-left-color: var(--c0); } .accent-0.active, .accent-0.tiny-pill.active { background: var(--c0); color:white; } .accent-0 input:checked { accent-color: var(--c0); }
        .accent-1 { border-left-color: var(--c1); } .accent-1.active, .accent-1.tiny-pill.active { background: var(--c1); color:white; } .accent-1 input:checked { accent-color: var(--c1); }
        .accent-2 { border-left-color: var(--c2); } .accent-2.active, .accent-2.tiny-pill.active { background: var(--c2); color:white; } .accent-2 input:checked { accent-color: var(--c2); }
        .accent-3 { border-left-color: var(--c3); } .accent-3.active, .accent-3.tiny-pill.active { background: var(--c3); color:white; } .accent-3 input:checked { accent-color: var(--c3); }
        .accent-4 { border-left-color: var(--c4); } .accent-4.active, .accent-4.tiny-pill.active { background: var(--c4); color:white; } .accent-4 input:checked { accent-color: var(--c4); }

        .mini-input { flex-grow: 1; padding: 12px; border-radius: 14px; border: 1px solid transparent; font-size: 16px; background: var(--input-bg); color: var(--text-color); outline: none; transition: 0.3s; }
        .inline-action-btn { width: 34px; height: 34px; border-radius: 50%; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.3s var(--bounce); border: none; font-size: 1.1rem; }
        .btn-confirm { background: rgba(52, 199, 89, 0.1); color: #34c759; margin-left: 2px; }
        .btn-confirm:hover { background: rgba(52, 199, 89, 0.2); transform: scale(1.1); }
        .btn-cancel { background: rgba(255, 59, 48, 0.1); color: #ff3b30; }
        .btn-cancel:hover { background: rgba(255, 59, 48, 0.2); transform: scale(1.1) rotate(90deg); }

        /* CALENDAR POPUP (High Z-Index, Fixed) */
        #globalPopup { 
            display: none; position: fixed; z-index: 10000; 
            background: var(--menu-bg); border: 1px solid var(--glass-border); 
            padding: 15px; border-radius: 20px; box-shadow: 0 15px 60px rgba(0,0,0,0.3); 
            width: 300px; flex-direction: column; gap: 10px; 
            animation: popIn 0.3s var(--bounce);
        }

        /* MODALS & MENUS */
        #settingsModal, #scoreModal, #snapModal, #datePickerModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .settings-card { background: var(--menu-bg); width: 92%; max-width: 450px; padding: 30px; border-radius: 40px; display: flex; flex-direction: column; gap: 15px; animation: popIn 0.5s var(--bounce); max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 80px rgba(0,0,0,0.3); }
        .settings-title { font-size: 1.8rem; font-weight: 900; text-align: center; margin: 0; letter-spacing: -1px; }
        .week-dropdown-btn { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 14px; padding: 8px 14px; font-size: 0.85rem; font-weight: 700; cursor: pointer; color: var(--text-color); display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .week-menu { display: none; position: absolute; top: 110%; left: 0; background: var(--menu-bg); border: 1px solid var(--glass-border); border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); padding: 8px; min-width: 150px; flex-direction: column; gap: 4px; animation: popIn 0.3s var(--bounce); z-index: 200; }
        .week-option { background: transparent; border: none; padding: 12px; text-align: left; font-weight: 700; font-size: 0.95rem; color: var(--text-color); border-radius: 12px; cursor: pointer; }
        .week-option.active { background: var(--input-bg); }

        /* GENIE MENU (BOTTOM CENTER) */
        #fab { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 65px; height: 65px; background: var(--text-color); color: var(--bg-color); border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 15px 40px rgba(0,0,0,0.25); cursor: pointer; z-index: 102; transition: transform 0.5s var(--bounce); font-size: 2rem; font-weight: 300; }
        #fab svg { transition: transform 0.5s var(--bounce); stroke: currentColor; width: 28px; height: 28px; }
        #fab.active svg { transform: rotate(135deg); }
        #fab:active { transform: scale(0.8); }
        
        .command-center { 
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 450px; 
            background: var(--menu-bg); 
            border: 1px solid var(--glass-border); 
            padding: 25px; display: flex; flex-direction: column; gap: 20px; 
            box-shadow: 0 30px 90px rgba(0,0,0,0.3); z-index: 100; 
            border-radius: 40px; transform-origin: bottom center; 
            transition: all 0.5s var(--bounce); 
        }
        .command-center.collapsed { transform: translateX(-50%) scale(0) translate(0, 100px); opacity: 0; pointer-events: none; }
        
        .input-row { display: flex; gap: 15px; align-items: center; width: 100%; margin-top: 5px; }
        /* NEW INPUT STYLE: Text Box + Integrated Tick Button */
        .fancy-input-wrapper { display: flex; align-items: center; background: var(--input-bg); border-radius: 30px; padding: 6px; flex-grow: 1; transition: transform 0.2s; box-shadow: inset 0 2px 6px rgba(0,0,0,0.03); }
        .fancy-input-wrapper input { background: transparent; border: none; padding: 12px 15px; font-size: 16px; color: var(--text-color); outline: none; flex-grow: 1; width: 100%; }
        .inner-add-btn { width: 42px; height: 42px; background: var(--accent-btn); color: var(--accent-icon); border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: transform 0.3s var(--bounce); flex-shrink: 0; font-weight: 900; }
        .inner-add-btn:active { transform: scale(0.8); }

        .selector-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; }
        .pill { padding: 14px 26px; background: var(--input-bg); border-radius: 50px; font-weight: 700; color: #888; white-space: nowrap; cursor: pointer; border: 1px solid transparent; transition: all 0.3s var(--bounce); }
        .pill.active { transform: scale(1.15); color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .pill.active[data-person="stevie"] { background: var(--stevie); } .pill.active[data-person="lucy"] { background: var(--lucy); } .pill.active[data-person="noah"] { background: var(--noah); } .pill.active[data-person="daisy"] { background: var(--daisy); } .pill.active[data-person="ella"] { background: var(--ella); } .pill.active[data-person="uni"] { background: var(--c0); } .pill.active[data-person="shopping"] { background: var(--c1); } .pill.active[data-person="work"] { background: var(--c2); } .pill.active[data-person="life"] { background: var(--c3); } .pill.active[data-person="other"] { background: var(--c4); }
        
        .day-pill { width: auto; padding: 12px 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; flex-shrink: 0; font-weight: 700; font-size: 0.8rem; background: var(--input-bg); color: var(--subtext-color); transition: all 0.3s var(--bounce); }
        .day-pill.active { background: var(--text-color); color: var(--bg-color); transform: scale(1.15); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .day-pill .tiny-date { font-size: 1.2rem; font-weight: 900; }
        
        .reminder-btn { width: 55px; height: 55px; border-radius: 50%; background: var(--input-bg); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; color: var(--subtext-color); transition: 0.3s var(--bounce); flex-shrink: 0; }
        .reminder-btn.active { color: #34c759; background: rgba(52, 199, 89, 0.1); transform: scale(1.1); }
        .picker-container { background: var(--chore-bg); padding: 30px; border-radius: 35px; display: flex; flex-direction: column; gap: 20px; width: 90%; max-width: 340px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popIn 0.4s var(--bounce); }
        .picker-input { padding: 18px; border: 1px solid var(--glass-border); background: var(--input-bg); border-radius: 16px; font-size: 1.2rem; color: var(--text-color); width: 100%; outline: none; font-weight: 600; }

        /* CONTEXT MENU (Big Buttons) */
        #contextMenu { display: none; position: fixed; background: var(--menu-bg); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 12px; z-index: 5000; flex-direction: column; min-width: 220px; animation: popIn 0.3s var(--bounce); transform-origin: top left; }
        .ctx-btn { background: var(--input-bg); padding: 16px; margin-bottom: 6px; border-radius: 14px; font-size: 1rem; text-align: center; font-weight: 700; display: flex; justify-content: center; gap: 8px; width: 100%; border: none; color: var(--text-color); transition: transform 0.2s; }
        .ctx-btn:hover { transform: scale(1.03); background: rgba(0,0,0,0.08); }
        .ctx-delete { background: rgba(255, 59, 48, 0.1); color: #ff3b30; }

        /* Week Pill Gradient Colors */
        #bottomWeekSelector .pill.active { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #bottomWeekSelector .pill:nth-child(2).active { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        #bottomWeekSelector .pill:nth-child(3).active { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        #bottomWeekSelector .pill:nth-child(4).active { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }

        /* NOTE FIX: Hidden by default, toggled via JS */
        .chore-note-input { display: none; margin-top: 10px; margin-left: 36px; width: calc(100% - 36px); background: var(--input-bg); border: none; border-radius: 10px; padding: 10px; font-size: 0.9rem; color: var(--text-color); resize: none; outline: none; font-family: inherit; }

        /* SETTINGS TOGGLES (Large & Bouncy) */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9ea; transition: .4s var(--bounce); border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s var(--bounce); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(26px); }

        #snapModal img { max-width: 100%; max-height: 80%; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .close-modal { position: absolute; top: 30px; right: 30px; color: white; font-size: 2.5rem; background: none; border: none; cursor: pointer; transition: transform 0.3s var(--bounce); }
        .close-modal:hover { transform: rotate(90deg) scale(1.2); }

        @keyframes popIn { from { transform: scale(0.6); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    
    <div id="capture-container">
        <header>
            <div class="header-left">
                <h1 id="appTitle">Squad Chores</h1>
                <button class="week-dropdown-btn" id="weekDropBtn" onclick="toggleWeekMenu(event)">
                    <span id="currentWeekLabel">Week 1</span> ‚ñº
                </button>
                <div id="weekDropdown" class="week-menu">
                    <button class="week-option" onclick="setWeek(1)">Week 1</button>
                    <button class="week-option" onclick="setWeek(2)">Week 2</button>
                    <button class="week-option" onclick="setWeek(3)">Week 3</button>
                    <button class="week-option" onclick="setWeek(4)">Week 4</button>
                </div>
            </div>
            <div class="header-tools">
                <button class="tool-pill" onclick="openScoreboard()">üèÜ</button>
                <button class="tool-pill" onclick="weeklyReset()">üìã</button>
                <button class="tool-pill" onclick="snapSchedule()">üì∏</button>
                <button class="tool-pill settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="schedule view-list" id="scheduleGrid"></div>
    </div>

    <div id="globalPopup">
        <div class="tiny-pill-scroll" id="globalPillScroll"></div>
        <div class="input-wrapper">
            <input type="text" class="mini-input" id="globalInput" placeholder="Task..." onkeydown="handleGlobalKey(event)">
            <button class="inline-action-btn btn-confirm" onclick="triggerGlobalAdd()">‚úî</button>
            <button class="inline-action-btn btn-cancel" onclick="hideGlobalPopup()">√ó</button>
        </div>
    </div>

    <div id="contextMenu">
        <button class="ctx-btn" onclick="performEdit()">‚úèÔ∏è Edit Text</button>
        <button class="ctx-btn" onclick="toggleInlineNote()">üìù Add/Edit Note</button>
        <button class="ctx-btn" onclick="openReschedule()">‚è∞ Reschedule</button>
        <button class="ctx-btn" onclick="showReassignMenu()">üë§ Reassign...</button>
        <div id="reassignSubmenu" style="display:none; border-top:1px solid rgba(0,0,0,0.1); margin-top:5px; padding-top:5px;"></div>
        <button class="ctx-btn ctx-delete" onclick="performDelete()">üóëÔ∏è Delete</button>
    </div>

    <div id="datePickerModal" onclick="if(event.target === this) closeDatePicker()">
        <div class="picker-container">
            <div class="settings-title">Pick a Time ‚è∞</div>
            <input type="datetime-local" id="visualDatePicker" class="picker-input">
            <div style="display:flex; gap:10px;">
                <button class="view-btn" style="flex:1" onclick="closeDatePicker()">Cancel</button>
                <button class="view-btn active" style="flex:1" onclick="confirmDate()">Set</button>
            </div>
        </div>
    </div>

    <div id="scoreModal" onclick="if(event.target === this) closeScoreboard()">
        <div class="settings-card">
            <div class="settings-title">Stats üìä</div>
            <div id="scoreList"></div>
            <button class="view-btn" onclick="closeScoreboard()" style="width:100%; margin-top:20px; background:#ddd; color:#333;">Close</button>
        </div>
    </div>

    <div id="settingsModal" onclick="if(event.target === this) closeSettings()">
        <div class="settings-card">
            <div class="settings-title">Settings ‚öôÔ∏è</div>
            <div class="mode-toggle-container">
                <button class="mode-btn active" id="mode-squad" onclick="switchAppMode('squad')">Squad üëØ‚Äç‚ôÄÔ∏è</button>
                <button class="mode-btn" id="mode-personal" onclick="switchAppMode('personal')">Personal üë§</button>
            </div>
            <div>
                <button class="dropdown-header" onclick="toggleNameDropdown()">
                    <span id="nameEditorTitle">Edit Names</span>
                    <span id="dropdown-arrow">‚ñº</span>
                </button>
                <div id="nameEditorContainer" class="dropdown-content" style="display:none;">
                    <div id="nameEditor"></div>
                    <button class="view-btn" style="width:100%; margin-top:10px;" onclick="addEntity()">+ Add New</button>
                    <button class="view-btn active" style="width:100%; margin-top:10px;" onclick="saveCustomNames()">Save Names</button>
                </div>
            </div>
            <div class="setting-row" style="flex-direction:column; align-items:center; gap:10px;">
                <span class="setting-label">Theme</span>
                <div style="display:flex; gap:10px;">
                    <button class="tool-pill" onclick="setTheme('light')">‚òÄÔ∏è</button>
                    <button class="tool-pill" onclick="setTheme('dark')">üåë</button>
                    <button class="tool-pill" onclick="setTheme('pink')">üå∏</button>
                    <button class="tool-pill" onclick="setTheme('blue')">üåä</button>
                    <button class="tool-pill" onclick="setTheme('green')">üåø</button>
                    <button class="tool-pill" onclick="setTheme('orange')">üçä</button>
                </div>
            </div>
            <div class="setting-row" style="flex-direction:column; align-items:flex-start; gap:10px;">
                <span class="setting-label">Layout Mode</span>
                <div class="view-options" style="width:100%">
                    <button class="view-btn active" onclick="setView('view-list')" id="btn-view-list">List</button>
                    <button class="view-btn" onclick="setView('view-board')" id="btn-view-board">Board</button>
                    <button class="view-btn" onclick="setView('view-calendar')" id="btn-view-calendar">Calendar</button>
                </div>
            </div>
            <div class="setting-row" style="flex-direction:column; gap:12px;">
                 <button class="ctx-btn" onclick="chaosMode()">üé≤ Shuffle</button>
                 <button class="ctx-btn ctx-delete" onclick="nukeData()">üóëÔ∏è Clear All</button>
            </div>
        </div>
    </div>

    <div id="snapModal">
        <button class="close-modal" onclick="closeSnap()">√ó</button>
        <img id="snapResult" src="" />
        <p style="color:white; margin-top:20px;">Long press to save ‚ú®</p>
    </div>

    <button id="fab" onclick="toggleGenie()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <div class="command-center collapsed" id="commandCenter" onclick="event.stopPropagation()">
        <div class="selector-scroll" id="personSelector"></div>
        <div class="selector-scroll" id="bottomWeekSelector">
            <div class="pill active" onclick="selectAddWeek(1)">W1</div>
            <div class="pill" onclick="selectAddWeek(2)">W2</div>
            <div class="pill" onclick="selectAddWeek(3)">W3</div>
            <div class="pill" onclick="selectAddWeek(4)">W4</div>
        </div>
        <div class="selector-scroll" id="daySelector"></div>
        
        <div class="input-row">
            <button class="reminder-btn" id="bellBtn" onclick="triggerDatePicker()">üîî</button>
            <div class="fancy-input-wrapper">
                <input type="text" id="choreInput" placeholder="Add item..." onkeydown="if(event.key === 'Enter') handleAdd()">
                <button class="inner-add-btn" onclick="handleAdd()">‚úî</button>
            </div>
        </div>
        
        <input type="datetime-local" id="hiddenDatePicker" class="hidden-date" onchange="handleDateSelection()" style="display:none">
        <input type="datetime-local" id="reschedulePicker" class="hidden-date" onchange="handleReschedule()" style="display:none">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            
            const DEFAULTS = {
                squad: { title: "Squad Chores", names: ["Stevie", "Lucy", "Noah", "Daisy", "Ella"] },
                personal: { title: "My Planner", names: ["Uni", "Shopping", "Work", "Life", "Other"] }
            };
            const colorPalette = ['#ff6b6b', '#e056fd', '#00cec9', '#f9ca24', '#4834d4'];

            // APP STATE
            let activeMode = localStorage.getItem('appMode') || 'squad'; 
            let currentView = localStorage.getItem('rotaView') || 'view-list';
            let currentTheme = localStorage.getItem('rotaTheme') || 'light';
            let activeWeek = parseInt(localStorage.getItem('activeWeek')) || 1; 
            
            let choreData = {}; 
            let currentNames = []; 
            let currentPerson = '';
            let currentDay = 'Monday';
            let selectedAddWeek = activeWeek; 
            let inlineSelection = {}; 
            
            let tempDate = null;
            let pickerMode = 'add';
            let menuTarget = { day: null, index: null };
            let globalPopupTarget = null;
            
            // Date Logic
            let today = new Date();
            let currentDayIndex = (today.getDay() + 6) % 7; 
            let mondayOffset = new Date(today);
            mondayOffset.setDate(today.getDate() - currentDayIndex);

            // --- INIT ---
            window.loadData = function() {
                const choreKey = activeMode === 'squad' ? 'squadChores' : 'personalTasks';
                try {
                    const stored = localStorage.getItem(choreKey);
                    choreData = stored ? JSON.parse(stored) : {};
                } catch (e) { choreData = {}; }
                
                days.forEach(day => { if (choreData[day] && Array.isArray(choreData[day])) { choreData[`w1-${day}`] = choreData[day]; delete choreData[day]; } });
                for(let w=1; w<=4; w++) { days.forEach(day => { const key = `w${w}-${day}`; if (!choreData[key]) choreData[key] = []; }); }
                const nameKey = activeMode === 'squad' ? 'squadNames' : 'personalNames';
                const storedNames = localStorage.getItem(nameKey);
                if (storedNames) { currentNames = JSON.parse(storedNames); } else { currentNames = [...DEFAULTS[activeMode].names]; }
                currentPerson = currentNames[0];
                days.forEach(day => inlineSelection[day] = currentPerson);
            }

            window.initUI = function() {
                setTheme(currentTheme);
                document.getElementById('scheduleGrid').className = `schedule ${currentView}`;
                updateViewButtons();
                document.getElementById('appTitle').innerText = DEFAULTS[activeMode].title;
                document.getElementById('nameEditorTitle').innerText = activeMode === 'squad' ? "Edit Squad Names" : "Edit Categories";
                document.getElementById('mode-squad').classList.toggle('active', activeMode === 'squad');
                document.getElementById('mode-personal').classList.toggle('active', activeMode === 'personal');
                
                updatePersonSelector();
                updateBottomMenuDates();
                renderNameEditor();
                updateWeekLabel();
                selectAddWeek(activeWeek); 
                render();
            }
            
            window.updatePersonSelector = function() {
                const personContainer = document.getElementById('personSelector');
                personContainer.innerHTML = '';
                currentNames.forEach((name, index) => {
                    const pill = document.createElement('div');
                    pill.className = `pill accent-${index % 5} ${name === currentPerson ? 'active' : ''}`;
                    pill.innerText = name.charAt(0).toUpperCase() + name.slice(1);
                    pill.onclick = (e) => {
                        e.stopPropagation(); // prevent menu close
                        selectPerson(name, index);
                    };
                    personContainer.appendChild(pill);
                });
            }

            window.updateBottomMenuDates = function() {
                const container = document.getElementById('daySelector');
                container.innerHTML = '';
                const weekOffset = (selectedAddWeek - 1) * 7; 
                days.forEach((dayName, idx) => {
                    let d = new Date(mondayOffset);
                    d.setDate(mondayOffset.getDate() + idx + weekOffset);
                    const dateNum = d.getDate();
                    const isSelected = (dayName === currentDay);
                    const pill = document.createElement('div');
                    pill.className = `day-pill ${isSelected ? 'active' : ''}`;
                    pill.innerHTML = `${dayName.substring(0,3)} <span class="tiny-date" style="font-size:1.1rem; font-weight:900;">${dateNum}</span>`;
                    pill.onclick = (e) => { 
                        e.stopPropagation(); // prevent menu close
                        currentDay = dayName; 
                        updateBottomMenuDates(); 
                    };
                    container.appendChild(pill);
                });
            }

            window.renderNameEditor = function() {
                const editorContainer = document.getElementById('nameEditor');
                editorContainer.innerHTML = '';
                currentNames.forEach((name, index) => {
                    const row = document.createElement('div');
                    row.className = 'name-edit-row';
                    row.innerHTML = `<div class="color-dot" style="background:${colorPalette[index % 5]}"></div><input type="text" class="name-input" id="edit-name-${index}" value="${name}"><button class="delete-name-btn" onclick="removeEntity(${index})">√ó</button>`;
                    editorContainer.appendChild(row);
                });
            }

            // --- WEEK LOGIC ---
            window.toggleWeekMenu = function(e) { e.stopPropagation(); const menu = document.getElementById('weekDropdown'); if(menu.style.display === 'flex') { menu.style.display = 'none'; } else { menu.style.display = 'flex'; document.addEventListener('click', closeWeekMenuOutside); } }
            function closeWeekMenuOutside(e) { const menu = document.getElementById('weekDropdown'); const btn = document.querySelector('.week-dropdown-btn'); if (!menu.contains(e.target) && !btn.contains(e.target)) { menu.style.display = 'none'; document.removeEventListener('click', closeWeekMenuOutside); } }
            window.setWeek = function(w) { activeWeek = w; selectedAddWeek = w; localStorage.setItem('activeWeek', w); updateWeekLabel(); updateBottomMenuDates(); selectAddWeek(w); document.getElementById('weekDropdown').style.display = 'none'; render(); }
            window.updateWeekLabel = function() { document.getElementById('currentWeekLabel').innerText = `Week ${activeWeek}`; }
            window.selectAddWeek = function(w) { 
                selectedAddWeek = w; updateBottomMenuDates(); 
                const pills = document.querySelectorAll('#bottomWeekSelector .pill'); 
                pills.forEach((p, idx) => { p.classList.toggle('active', (idx + 1) === w); }); 
            }

            // --- RENDER ENGINE ---
            window.render = function() {
                try {
                    const grid = document.getElementById('scheduleGrid');
                    if(!grid) return; 
                    grid.innerHTML = '';
                    const isCalendar = currentView === 'view-calendar';
                    const weekDropBtn = document.getElementById('weekDropBtn');
                    if (isCalendar) weekDropBtn.style.display = 'none'; else weekDropBtn.style.display = 'flex';
                    const weeksToShow = isCalendar ? [1, 2, 3, 4] : [activeWeek];

                    weeksToShow.forEach(weekNum => {
                        // NO HEADER IN CALENDAR VIEW
                        if (isCalendar) {
                             // Do nothing
                        }

                        days.forEach((day, dayIndex) => {
                            const dataKey = `w${weekNum}-${day}`;
                            const dayCard = document.createElement('div');
                            dayCard.className = 'day-card';
                            
                            let dateCalc = new Date(mondayOffset);
                            dateCalc.setDate(mondayOffset.getDate() + dayIndex + ((weekNum - 1) * 7));
                            const dateStr = dateCalc.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            const isToday = dateCalc.toDateString() === new Date().toDateString();
                            if(isToday) dayCard.classList.add('is-today');

                            const dateDisplayHtml = `<span class="date-display">${dateStr}</span>`;
                            const dateNumHtml = isCalendar ? `<div class="date-number">${dateStr}</div>` : '';

                            let choresHtml = '';
                            if (choreData[dataKey] && choreData[dataKey].length > 0) {
                                choresHtml = choreData[dataKey].map((chore, index) => {
                                    const isDone = chore.done ? 'done' : '';
                                    const isChecked = chore.done ? 'checked' : '';
                                    const noteText = chore.note ? chore.note : '';
                                    const hasNote = chore.note && chore.note.length > 0;
                                    let badgeHtml = '';
                                    if (chore.due) {
                                        const dateObj = new Date(chore.due);
                                        const now = new Date();
                                        const isFuture = dateObj > now;
                                        const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                        const dateStr2 = dateObj.toDateString() === now.toDateString() ? "Today" : dateObj.toLocaleDateString([], {weekday: 'short', day: 'numeric'});
                                        badgeHtml = `<div class="due-badge ${isFuture ? 'future' : ''}">‚è∞ ${dateStr2}, ${timeStr}</div>`;
                                    }
                                    let colorIdx = currentNames.indexOf(chore.person);
                                    if (colorIdx === -1) colorIdx = 0; 
                                    return `
                                    <div class="chore-item accent-${colorIdx % 5} ${isDone}" id="chore-${dataKey}-${index}">
                                        <div class="chore-header">
                                            <div class="chore-left" onclick="toggleDone('${dataKey}', ${index}, event)">
                                                <input type="checkbox" class="chore-checkbox" ${isChecked}>
                                                <span class="chore-text">${chore.person}: ${chore.text} ${hasNote ? 'üìù' : ''}</span>
                                            </div>
                                            <button class="menu-btn" onclick="toggleMenu(event, '${dataKey}', ${index})">‚ãÆ</button>
                                        </div>
                                        ${!isCalendar ? badgeHtml : ''}
                                        ${!isCalendar ? `<div class="chore-note-display" id="note-display-${dataKey}-${index}" style="display:${hasNote ? 'block' : 'none'}" onclick="toggleInlineNoteManual('${dataKey}', ${index})">${noteText}</div><textarea class="chore-note-input" id="note-input-${dataKey}-${index}" rows="2" placeholder="Add a note..." onblur="saveInlineNote('${dataKey}', ${index})">${noteText}</textarea>` : ''}
                                    </div>`;
                                }).join('');
                            } else {
                                if (!isCalendar) choresHtml = `<div class="empty-state">Nothing here yet.</div>`;
                            }

                            const currentInlinePerson = inlineSelection[day];
                            const pillsHtml = currentNames.map((name, idx) => `<button class="tiny-pill accent-${idx % 5} ${name === currentInlinePerson ? 'active' : ''}" onclick="setInlinePerson('${dataKey}', '${name}')">${name.charAt(0).toUpperCase() + name.slice(1)}</button>`).join('');

                            const inlineInputHtml = isCalendar 
                                ? `<button class="new-btn-ghost" onclick="showGlobalPopup(event, '${dataKey}')">+ New</button>`
                                : `<div class="inline-add-row" id="inlineRow-${dataKey}"><button class="new-btn-ghost" id="btn-${dataKey}" onclick="showInlineInput('${dataKey}')">+ New</button><div class="inline-input-container" id="inputContainer-${dataKey}"><div class="tiny-pill-scroll">${pillsHtml}</div><div class="input-wrapper"><input type="text" class="mini-input" id="input-${dataKey}" placeholder="Task..." onkeydown="handleInlineKey(event, '${dataKey}')"><button class="inline-action-btn btn-confirm" onclick="triggerAdd('${dataKey}')">‚úî</button><button class="inline-action-btn btn-cancel" onclick="hideInlineInput('${dataKey}')">√ó</button></div></div></div>`;

                            dayCard.innerHTML = `${dateNumHtml}<div class="day-title">${day} ${!isCalendar ? dateDisplayHtml : ''} ${isCalendar ? '' : '<span>'+(choreData[dataKey] ? choreData[dataKey].length : 0)+'</span>'}</div><div class="chore-list">${choresHtml}</div>${inlineInputHtml}`;
                            grid.appendChild(dayCard);
                        });
                    });
                } catch (e) {
                    console.error("Render error", e);
                    if(confirm("Data corruption detected. Reset to fix?")) { localStorage.clear(); location.reload(); }
                }
            }

            // --- GLOBAL POPUP (CALENDAR) ---
            window.showGlobalPopup = function(e, key) {
                e.stopPropagation();
                globalPopupTarget = key;
                const popup = document.getElementById('globalPopup');
                const pillContainer = document.getElementById('globalPillScroll');
                
                const rect = e.target.getBoundingClientRect();
                let topPos = rect.bottom + window.scrollY + 10;
                // Avoid off-screen bottom
                if (rect.bottom > window.innerHeight - 300) topPos = rect.top + window.scrollY - 200;
                
                popup.style.top = topPos + 'px';
                // Center logic relative to card, but keep on screen
                let left = rect.left - 50;
                if(left + 320 > window.innerWidth) left = window.innerWidth - 340;
                if(left < 10) left = 10;
                
                popup.style.left = left + 'px';
                
                const currentInlinePerson = inlineSelection[key.split('-')[1]];
                pillContainer.innerHTML = currentNames.map((name, idx) => `<button class="tiny-pill accent-${idx % 5} ${name === currentInlinePerson ? 'active' : ''}" onclick="setGlobalPerson('${name}', ${idx})">${name.charAt(0).toUpperCase() + name.slice(1)}</button>`).join('');
                document.getElementById('globalInput').value = '';
                document.getElementById('globalInput').focus();
                document.getElementById('globalInput').onkeydown = (e) => { if(e.key === 'Enter') triggerGlobalAdd(); };
                popup.style.display = 'flex';
                document.addEventListener('click', closeGlobalPopupOutside);
            }
            function closeGlobalPopupOutside(e) { const popup = document.getElementById('globalPopup'); if(popup && !popup.contains(e.target)) hideGlobalPopup(); }
            window.hideGlobalPopup = function() { document.getElementById('globalPopup').style.display = 'none'; document.removeEventListener('click', closeGlobalPopupOutside); }
            window.setGlobalPerson = function(name, idx) { const pills = document.querySelectorAll('#globalPillScroll .tiny-pill'); pills.forEach(p => p.classList.remove('active')); pills[idx].classList.add('active'); const day = globalPopupTarget.split('-')[1]; inlineSelection[day] = name; document.getElementById('globalInput').focus(); }
            window.triggerGlobalAdd = function() { const text = document.getElementById('globalInput').value; if(!text.trim()) return; const day = globalPopupTarget.split('-')[1]; const person = inlineSelection[day]; choreData[globalPopupTarget].push({ person: person, text: text, done: false, note: "", due: null, notified: false }); saveData(); hideGlobalPopup(); }

            // --- DATE PICKER ---
            window.triggerDatePicker = function() { requestNotificationPermission(); pickerMode = 'add'; document.getElementById('visualDatePicker').value = ''; document.getElementById('datePickerModal').style.display = 'flex'; }
            window.closeDatePicker = function() { document.getElementById('datePickerModal').style.display = 'none'; }
            window.confirmDate = function() {
                const val = document.getElementById('visualDatePicker').value;
                if (pickerMode === 'add') { tempDate = val; const btn = document.getElementById('bellBtn'); if(val) btn.classList.add('active'); else btn.classList.remove('active'); } 
                else if (pickerMode === 'reschedule') { const {day, index} = menuTarget; choreData[day][index].due = val; choreData[day][index].notified = false; saveData(); }
                closeDatePicker();
            }
            window.openReschedule = function() { closeMenu(); pickerMode = 'reschedule'; const {day, index} = menuTarget; document.getElementById('visualDatePicker').value = choreData[day][index].due || ''; document.getElementById('datePickerModal').style.display = 'flex'; }

            // --- NOTIFICATION ---
            function requestNotificationPermission() { if ("Notification" in window && Notification.permission !== 'granted') Notification.requestPermission(); }
            function checkReminders() { if (Notification.permission !== 'granted') return; const now = new Date(); Object.keys(choreData).forEach(key => { choreData[key].forEach(chore => { if (chore.due && !chore.done && !chore.notified) { const dueDate = new Date(chore.due); if (dueDate <= now && (now - dueDate) < 60000) { new Notification(`Squad Chores`, { body: `${chore.person}: ${chore.text} is due!` }); chore.notified = true; saveData(); } } }); }); }
            setInterval(checkReminders, 30000);

            // --- ADD/ACTION ---
            window.handleAdd = function() { const text = document.getElementById('choreInput').value; if (!text) return alert("Type something."); const key = `w${selectedAddWeek}-${currentDay}`; if (!choreData[key]) choreData[key] = []; choreData[key].push({ person: currentPerson, text: text, done: false, note: "", due: tempDate || null, notified: false }); document.getElementById('choreInput').value = ''; tempDate = null; document.getElementById('bellBtn').classList.remove('active'); saveData(); }
            window.showReassignMenu = function() { 
                const sub = document.getElementById('reassignSubmenu'); sub.style.display = 'block'; sub.innerHTML = '<div class="ctx-header">Reassign To:</div>';
                currentNames.forEach((name, idx) => { const btn = document.createElement('button'); btn.className = 'ctx-btn'; btn.innerHTML = `<span class="color-dot" style="background:${colorPalette[idx%5]}"></span> ${name}`; btn.onclick = () => { choreData[menuTarget.day][menuTarget.index].person = name; saveData(); closeMenu(); }; sub.appendChild(btn); }); 
            }

            // --- UTILS ---
            window.switchAppMode = function(mode) { if (mode === activeMode) return; activeMode = mode; localStorage.setItem('appMode', mode); loadData(); initUI(); }
            window.toggleNameDropdown = function() { const container = document.getElementById('nameEditorContainer'); const arrow = document.getElementById('dropdown-arrow'); if (container.style.display === 'none') { container.style.display = 'block'; arrow.style.transform = 'rotate(180deg)'; } else { container.style.display = 'none'; arrow.style.transform = 'rotate(0deg)'; } }
            window.addEntity = function() { currentNames.push(`New ${activeMode === 'squad' ? 'Person' : 'Category'}`); renderNameEditor(); }
            window.removeEntity = function(index) { if(currentNames.length <= 1) return alert("Min 1 name!"); if(confirm(`Remove "${currentNames[index]}"?`)) { currentNames.splice(index, 1); renderNameEditor(); } }
            window.saveCustomNames = function() {
                const oldNames = JSON.parse(localStorage.getItem(activeMode === 'squad' ? 'squadNames' : 'personalNames') || '[]');
                if(oldNames.length === 0) oldNames.push(...DEFAULTS[activeMode].names); 
                const updatedNames = []; document.querySelectorAll('.name-input').forEach(input => updatedNames.push(input.value.trim() || "Untitled"));
                Object.keys(choreData).forEach(key => { choreData[key].forEach(chore => { const idx = oldNames.indexOf(chore.person); if (idx !== -1 && updatedNames[idx]) chore.person = updatedNames[idx]; }); });
                currentNames = updatedNames; currentPerson = currentNames[0]; 
                const nameKey = activeMode === 'squad' ? 'squadNames' : 'personalNames'; localStorage.setItem(nameKey, JSON.stringify(currentNames)); saveData(); initUI(); closeSettings();
            }
            window.saveData = function() { const choreKey = activeMode === 'squad' ? 'squadChores' : 'personalTasks'; localStorage.setItem(choreKey, JSON.stringify(choreData)); window.render(); }
            window.toggleDone = function(day, index, event) { if(event) event.stopPropagation(); const newStatus = !choreData[day][index].done; choreData[day][index].done = newStatus; const card = document.getElementById(`chore-${day}-${index}`); if(card && newStatus) { card.classList.add('bouncing', 'done'); card.querySelector('input').checked = true; const person = choreData[day][index].person; const idx = currentNames.indexOf(person); const color = colorPalette[idx % 5] || '#ffffff'; confetti({ origin: { x: event.clientX/window.innerWidth, y: event.clientY/window.innerHeight }, particleCount: 40, spread: 70, colors: [color, '#ffffff'] }); } else if(card) { card.classList.remove('done'); card.querySelector('input').checked = false; } saveData(); }

            window.showInlineInput = function(key) { document.getElementById(`btn-${key}`).style.display = 'none'; document.getElementById(`inputContainer-${key}`).style.display = 'flex'; document.getElementById(`input-${key}`).focus(); }
            window.hideInlineInput = function(key) { document.getElementById(`btn-${key}`).style.display = 'block'; document.getElementById(`inputContainer-${key}`).style.display = 'none'; }
            window.setInlinePerson = function(key, name) { inlineSelection[key.split('-')[1]] = name; const container = document.getElementById(`inputContainer-${key}`); const buttons = container.querySelectorAll('.tiny-pill'); buttons.forEach(btn => { btn.classList.remove('active'); if(btn.innerText.toLowerCase() === name.toLowerCase()) btn.classList.add('active'); }); document.getElementById(`input-${key}`).focus(); }
            window.triggerAdd = function(key) { const text = document.getElementById(`input-${key}`).value; const day = key.split('-')[1]; const person = inlineSelection[day]; if (!text.trim()) return; choreData[key].push({ person: person, text: text, done: false, note: "", due: null, notified: false }); saveData(); setTimeout(() => { window.showInlineInput(key); }, 10); }
            window.handleInlineKey = function(event, key) { if (event.key === 'Enter') triggerAdd(key); }

            window.selectPerson = function(name, index) { currentPerson = name; updatePersonSelector(); }
            window.selectDay = function(day) { currentDay = day; updateBottomMenuDates(); }
            
            window.toggleMenu = function(e, day, index) { e.stopPropagation(); const menu = document.getElementById('contextMenu'); document.getElementById('reassignSubmenu').style.display = 'none'; menuTarget = { day, index }; const rect = e.target.getBoundingClientRect(); menu.style.top = `${rect.bottom + 5}px`; menu.style.left = `${rect.left - 120}px`; menu.style.display = 'flex'; document.addEventListener('click', closeMenuOutside); }
            function closeMenuOutside(e) { const menu = document.getElementById('contextMenu'); if (!menu.contains(e.target)) { menu.style.display = 'none'; document.removeEventListener('click', closeMenuOutside); } }
            window.closeMenu = function() { document.getElementById('contextMenu').style.display = 'none'; }
            window.performEdit = function() { const { day, index } = menuTarget; const newText = prompt("Edit:", choreData[day][index].text); if(newText) { choreData[day][index].text = newText; saveData(); } document.getElementById('contextMenu').style.display = 'none'; }
            window.performDelete = function() { const { day, index } = menuTarget; if(confirm("Delete?")) { choreData[day].splice(index, 1); saveData(); } document.getElementById('contextMenu').style.display = 'none'; }
            window.toggleInlineNote = function() { document.getElementById('contextMenu').style.display = 'none'; toggleInlineNoteManual(menuTarget.day, menuTarget.index); }
            window.toggleInlineNoteManual = function(day, index) { const display = document.getElementById(`note-display-${day}-${index}`); const input = document.getElementById(`note-input-${day}-${index}`); 
                // Toggle input visibility
                if(input.style.display === 'block') { input.style.display = 'none'; } else { input.style.display = 'block'; input.focus(); }
            }
            window.saveInlineNote = function(day, index) { 
                const input = document.getElementById(`note-input-${day}-${index}`); 
                const display = document.getElementById(`note-display-${day}-${index}`); 
                choreData[day][index].note = input.value; 
                saveData(); 
                // Update display and hide input
                if(input.value.length > 0) { display.style.display = 'block'; display.innerText = input.value; } else { display.style.display = 'none'; }
                input.style.display = 'none'; 
            }

            window.openSettings = function() { document.getElementById('settingsModal').style.display = 'flex'; document.getElementById('nameEditorContainer').style.display = 'none'; document.getElementById('dropdown-arrow').style.transform = 'rotate(0deg)'; }
            window.closeSettings = function() { document.getElementById('settingsModal').style.display = 'none'; }
            window.setTheme = function(theme) { 
                document.body.className = ''; 
                if(theme === 'dark') document.body.classList.add('dark-mode');
                else if(theme !== 'light') document.body.classList.add('theme-' + theme); 
                localStorage.setItem('rotaTheme', theme); 
                currentTheme = theme; 
            }
            window.setView = function(viewName) { currentView = viewName; document.getElementById('scheduleGrid').className = `schedule ${viewName}`; localStorage.setItem('rotaView', viewName); updateViewButtons(); updateWeekLabel(); render(); }
            window.updateViewButtons = function() { document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active')); const activeBtn = document.getElementById(`btn-${currentView}`); if(activeBtn) activeBtn.classList.add('active'); }
            window.nukeData = function() { if(confirm(`Clear ALL ${activeMode} data?`)) { Object.keys(choreData).forEach(key => choreData[key] = []); saveData(); closeSettings(); } }
            window.chaosMode = function() { if (activeMode !== 'squad') return alert("Squad only!"); if (!confirm("Randomize?")) return; days.forEach(day => { const key = `w${activeWeek}-${day}`; if(choreData[key]) choreData[key].forEach(chore => { chore.person = currentNames[Math.floor(Math.random() * currentNames.length)]; }); }); saveData(); closeSettings(); }
            window.weeklyReset = function() { if (activeMode === 'personal') return alert("Squad only!"); if(!confirm("Reset current week?")) return; const cleanDay = days[Math.floor(Math.random() * 5)]; if(!choreData[`w${activeWeek}-Saturday`]) choreData[`w${activeWeek}-Saturday`] = []; choreData[`w${activeWeek}-Saturday`].push({ person: currentNames[Math.floor(Math.random()*5)], text: "Bins üóëÔ∏è", done: false, note: "", due: null, notified: false }); if(!choreData[`w${activeWeek}-${cleanDay}`]) choreData[`w${activeWeek}-${cleanDay}`] = []; choreData[`w${activeWeek}-${cleanDay}`].push({ person: currentNames[Math.floor(Math.random()*5)], text: "Clean üßΩ", done: false, note: "", due: null, notified: false }); saveData(); }
            window.openScoreboard = function() { const scores = {}; currentNames.forEach(p => scores[p] = 0); Object.values(choreData).flat().forEach(c => { if(c.done && scores[c.person] !== undefined) scores[c.person]++; }); const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]); const maxScore = sorted[0][1] || 1; let html = ''; sorted.forEach(([name, score]) => { const percent = (score / maxScore) * 100; const idx = currentNames.indexOf(name); const color = colorPalette[idx % 5]; html += `<div class="score-row"><span class="score-name" style="color:${color}">${name.toUpperCase()}</span><div class="score-bar-container"><div class="score-bar" style="width:${percent}%; background:${color};"></div></div><span class="score-count">${score}</span></div>`; }); document.getElementById('scoreList').innerHTML = html; document.getElementById('scoreModal').style.display = 'flex'; }
            window.closeScoreboard = function() { document.getElementById('scoreModal').style.display = 'none'; }
            
            document.addEventListener('click', (e) => {
                const openContainer = document.querySelector('.inline-input-container[style*="display: flex"]');
                if(openContainer) { 
                    const dataKey = openContainer.id.replace('inputContainer-', ''); 
                    const btn = document.getElementById(`btn-${dataKey}`); 
                    if(!openContainer.contains(e.target) && (!btn || !btn.contains(e.target))) { hideInlineInput(dataKey); }
                }
                const commandCenter = document.getElementById('commandCenter'); const fab = document.getElementById('fab'); if (!commandCenter.classList.contains('collapsed') && !commandCenter.contains(e.target) && !fab.contains(e.target)) { toggleGenie(); }
            });

            window.toggleGenie = function() { const center = document.getElementById('commandCenter'); const fab = document.getElementById('fab'); if (center.classList.contains('collapsed')) { center.classList.remove('collapsed'); fab.classList.add('active'); } else { center.classList.add('collapsed'); fab.classList.remove('active'); } }
            window.snapSchedule = function() { document.querySelector('.command-center').style.display = 'none'; document.getElementById('fab').style.display = 'none'; document.querySelectorAll('.header-tools').forEach(el => el.style.display = 'none'); document.querySelector('.header-left').style.display = 'none'; document.body.classList.add('snapping-mode'); setTimeout(() => { html2canvas(document.getElementById('capture-container'), { backgroundColor: currentTheme === 'dark' ? '#000000' : '#f2f2f7', scale: 2 }).then(canvas => { canvas.toBlob(function(blob) { const file = new File([blob], "squad-chores.png", { type: "image/png" }); if (navigator.canShare && navigator.canShare({ files: [file] })) { navigator.share({ files: [file], title: 'Squad Chores' }).then(() => { restoreUI(); }).catch(() => { showModal(canvas); }); } else { showModal(canvas); } }); }); }, 100); }
            window.showModal = function(canvas) { const imgData = canvas.toDataURL("image/png"); document.getElementById('snapResult').src = imgData; document.getElementById('snapModal').style.display = 'flex'; restoreUI(); }
            window.restoreUI = function() { document.querySelector('.command-center').style.display = 'flex'; if(document.querySelector('.command-center').classList.contains('collapsed')) document.getElementById('fab').style.display = 'flex'; document.querySelectorAll('.header-tools').forEach(el => el.style.display = 'flex'); document.querySelector('.header-left').style.display = 'flex'; document.body.classList.remove('snapping-mode'); }
            window.closeSnap = function() { document.getElementById('snapModal').style.display = 'none'; }

            loadData(); initUI();
        });
    </script>
</body>
</html>